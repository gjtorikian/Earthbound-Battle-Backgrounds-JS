var suggestedLayers = {
  "Coil Snake (306 / 307)": [306, 307],
  "Runaway Dog (260 / 0)": [260, 0],
  "Skate Punk, Pogo Punk (6 / 0)": [6, 0],
  "Skate Punk, Yes Man Junior (5 / 0)": [5, 0],
  "Skate Punk, Yes Man Junior, Pogo Punk (8 / 0)": [8, 0],
  "Pogo Punk, Yes Man Junior (7 / 0)": [7, 0],
  "Runaway Dog, Cop (1 / 0)": [1, 0],
  "Attack Slug (75 / 0)": [75, 0],
  "Rowdy Mouse, Attack Slug (72 / 0)": [72, 0],
  "Black Antoid, Attack Slug (81 / 0)": [81, 0],
  "Black Antoid, Rowdy Mouse (80 / 0)": [80, 0],
  "Frank (180 / 179)": [180, 179],
  "Rowdy Mouse (217 / 216)": [217, 216],
  "Starman Junior (219 / 218)": [219, 218],
  "Black Antoid (79 / 0)": [79, 0],
  "Black Antoid (9 / 0)": [9, 0],
  "Black Antoid, Ramblin' Evil Mushroom (10 / 0)": [10, 0],
  "Cop (184 / 183)": [184, 183],
  "Frankystein Mark II (182 / 181)": [182, 181],
  "Gruff Goat (122 / 0)": [122, 0],
  "Gruff Goat (127 / 0)": [127, 0],
  "Ramblin' Evil Mushroom (12 / 0)": [12, 0],
  "Worthless Protoplasm (156 / 0)": [156, 0],
  "Worthless Protoplasm (215 / 214)": [215, 214],
  "Cranky Lady (14 / 0)": [14, 0],
  "Mad Duck (213 / 212)": [213, 212],
  "Mad Duck (33 / 0)": [33, 0],
  "Mr Batty (73 / 0)": [73, 0],
  "Mobile Sprout, Ramblin' Evil Mushroom (212 / 213)": [212, 213],
  "Unassuming Local Guy (269 / 270)": [269, 270],
  "Unassuming Local Guy (307 / 306)": [307, 306],
  "Titanic Ant, Black Antoid (170 / 169)": [170, 169],
  "Cave Boy (314 / 0)": [314, 0],
  "Mobile Sprout, Li'l UFO (21 / 0)": [21, 0],
  "Li'l UFO (20 / 0)": [20, 0],
  "Mobile Sprout, Territorial Oak (11 / 0)": [11, 0],
  "Insane Cultist (16 / 0)": [16, 0],
  "Red Antoid, Black Antoid (317 / 0)": [317, 0],
  "Mole Playing Rough (82 / 0)": [82, 0],
  "Spinning Robo (22 / 0)": [22, 0],
  "Everdred (273 / 272)": [273, 272],
  "Mr. Batty (89 / 0)": [89, 0],
  "Foppy (274 / 275)": [274, 275],
  "Foppy (276 / 277)": [276, 277],
  "Handsome Tom (25 / 0)": [25, 0],
  "Mighty Bear (76 / 0)": [76, 0],
  "Trick or Trick Kid, Handsome Tom (3 / 0)": [3, 0],
  "Zombie Possessor (152 / 0)": [152, 0],
  "Handsome Tom, Smilin' Sam (15 / 0)": [15, 0],
  "Mad Duck, Thirsty Coil Snake (137 / 0)": [137, 0],
  "No Good Fly, Putrid Moldyman (28 / 0)": [28, 0],
  "Violent Roach (186 / 185)": [186, 185],
  "Violent Roach (34 / 0)": [34, 0],
  "Zombie Dog, No Good Fly (154 / 0)": [154, 0],
  "Zombie Possessor, Urban Zombie (26 / 0)": [26, 0],
  "Farm Zombie (281 / 282)": [281, 282],
  "Mostly Bad Fly (280 / 0)": [280, 0],
  "Struttin' Evil Mushroom, Tough Mobile Sprout (134 / 0)": [134, 0],
  "Urban Zombie (27 / 0)": [27, 0],
  "Armored Frog, Farm Zombie (30 / 0)": [30, 0],
  "Red Antoid, Armored Frog, Farm Zombie (32 / 0)": [32, 0],
  "Urban Zombie, Zombie Dog (153 / 0)": [153, 0],
  "Mr. Carpainter (278 / 0)": [278, 0],
  "Armored Frog (316 / 0)": [316, 0],
  "Plain Crocodile, Red Antoid (31 / 0)": [31, 0],
  "Tough Mobile Sprout, Ranboob (133 / 0)": [133, 0],
  "Zombie Dog (29 / 0)": [29, 0],
  "Criminal Caterpillar (266 / 267)": [266, 267],
  "Mondo Mole (172 / 171)": [172, 171],
  "Scalding Coffee Cup, Mystical Record, Worthless Protoplasm (159 / 0)": [
    159,
    0,
  ],
  "Ranboob (132 / 0)": [132, 0],
  "Ranboob (135 / 0)": [135, 0],
  "Slimy Little Pile (192 / 191)": [192, 191],
  "Boogey Tent (293 / 292)": [293, 292],
  "Skelpion, Cute Li'l UFO (259 / 0)": [259, 0],
  "Skelpion, Smilin' Sphere (318 / 0)": [318, 0],
  "Trillionage Sprout, Tough Mobile Sprout (174 / 173)": [174, 173],
  "Cave Boy, Mighty Bear Seven (131 / 0)": [131, 0],
  "Crested Booka, Cute Li'l UFO, Smilin' Sphere (319 / 0)": [319, 0],
  "Cute Li'l UFO (155 / 0)": [155, 0],
  "Extra Cranky Lady (39 / 0)": [39, 0],
  "Master Belch (194 / 193)": [194, 193],
  "Spiteful Crow (123 / 0)": [123, 0],
  "Spiteful Crow (126 / 0)": [126, 0],
  "Spiteful Crow (262 / 0)": [262, 0],
  "Mad Taxi (203 / 202)": [203, 202],
  "Mad Taxi (41 / 0)": [41, 0],
  "Mad Taxi (83 / 0)": [83, 0],
  "Thirsty Coil Snake (136 / 0)": [136, 0],
  "Desert Wolf (38 / 0)": [38, 0],
  "Gigantic Ant (138 / 0)": [138, 0],
  "Gigantic Ant (139 / 0)": [139, 0],
  "Annoying Reveler (42 / 0)": [42, 0],
  "Crested Booka, Bad Buffalo (36 / 0)": [36, 0],
  "Scalding Coffee Cup, Mystical Record (84 / 0)": [84, 0],
  "Scalding Coffee Cup, Mystical Record (87 / 0)": [87, 0],
  "Arachnid! (78 / 0)": [78, 0],
  "Bad Buffalo, Desert Wolf (35 / 0)": [35, 0],
  "Enraged Fire Plug (162 / 0)": [162, 0],
  "Enraged Fire Plug (189 / 0)": [189, 0],
  "Enraged Fire Plug (320 / 0)": [320, 0],
  "Guardian Digger (196 / 0)": [196, 0],
  "Elder Batty, Arachnid! (73 / 0)": [73, 0],
  "Crazed Sign (40 / 0)": [40, 0],
  "Crazed Sign (48 / 0)": [48, 0],
  "Dali's Clock (158 / 0)": [158, 0],
  "Dali's Clock (43 / 0)": [43, 0],
  "Musica, Mystical Record (85 / 0)": [85, 0],
  "Musica, Mystical Record (86 / 0)": [86, 0],
  "Robo-pump, Enraged Fire Plug (288 / 0)": [288, 0],
  "Robo-pump, Enraged Fire Plug (45 / 258)": [45, 258],
  "Abstract Art (44 / 0)": [44, 0],
  "Over Zealous Cop, Tough Guy (49 / 0)": [49, 0],
  "Robo-pump (157 / 0)": [157, 0],
  "Master Criminal Worm (190 / 326)": [190, 326],
  "Strong Crocodile, Arachnid! (74 / 0)": [74, 0],
  "Tough Guy (46 / 0)": [46, 0],
  "Lesser Mook (161 / 0)": [161, 0],
  "Lesser Mook, Whirling Robo (125 / 0)": [125, 0],
  "Lesser Mook, Whirling Robo (315 / 0)": [315, 0],
  "Lesser Mook, Wooly Shambler (313 / 0)": [313, 0],
  "Pit Bull Slug (61 / 0)": [61, 0],
  "Sentry Robot (284 / 0)": [284, 0],
  "Wooly Shambler, Whirling Robo (130 / 0)": [130, 0],
  "Deadly Mouse, Stinky Ghost (143 / 0)": [143, 0],
  "Dept. Store Spook (197 / 0)": [197, 0],
  "Filthy Attack Roach (140 / 0)": [140, 0],
  "Filthy Attack Roach (141 / 0)": [141, 0],
  "Thunder Mite (51 / 0)": [51, 0],
  "Beautiful UFO (54 / 0)": [54, 0],
  "Arachnid!!! (95 / 0)": [95, 0],
  "Dread Skelpion, Great Crested Booka (56 / 0)": [56, 0],
  "Evil Mani-Mani (302 / 0)": [302, 0],
  "High-class UFO, Beautiful UFO (53 / 0)": [53, 0],
  "Thunder Mite, Tangoo (304 / 0)": [304, 0],
  "Clumsy Robot (285 / 0)": [285, 0],
  "Kiss of Death (144 / 0)": [144, 0],
  "Lethal Asp Hieroglyph (99 / 0)": [99, 0],
  "Stinky Ghost (142 / 0)": [142, 0],
  "Fierce Shattered Man, Arachnid!!! (96 / 0)": [96, 0],
  "High-class UFO (321 / 0)": [321, 0],
  "Plague Rat of Doom (178 / 177)": [178, 177],
  "Even Slimier Little Pile, Zap Eel (62 / 0)": [62, 0],
  "Fobby (289 / 0)": [289, 0],
  "Fobby (290 / 0)": [290, 0],
  "Fobby (291 / 0)": [291, 0],
  "Fobby (312 / 0)": [312, 0],
  "Manly Fish, Hard Crocodile (63 / 0)": [63, 0],
  "Shrooom! (168 / 167)": [168, 167],
  "Tangoo (146 / 0)": [146, 0],
  "Tangoo (305 / 0)": [305, 0],
  "Great Crested Booka (52 / 0)": [52, 0],
  "Marauder Octobot (55 / 0)": [55, 0],
  "Demonic Petunia (59 / 0)": [59, 0],
  "Fierce Shattered Man (294 / 0)": [294, 0],
  "Fierce Shattered Man (98 / 0)": [98, 0],
  "Fierce Shattered Man, Petrified Royal Guard (97 / 0)": [97, 0],
  "Shattered Man (195 / 0)": [195, 0],
  "Zap Eel, Hard Crocodile (60 / 0)": [60, 0],
  "Conducting Menace (145 / 0)": [145, 0],
  "Hyper Spinning Robo, Fobby (102 / 0)": [102, 0],
  "Uncontrollable Sphere, Fobby (100 / 0)": [100, 0],
  "Kraken (201 / 200)": [201, 200],
  "Mook Senior (151 / 0)": [151, 0],
  "Mook Senior (160 / 0)": [160, 0],
  "Mook Senior (198 / 0)": [198, 0],
  "Mook Senior (324 / 0)": [324, 0],
  "Atomic Power Robot, Starman (243 / 0)": [243, 0],
  "Guardian General (208 / 0)": [208, 0],
  "Starman (271 / 0)": [271, 0],
  "Starman (283 / 0)": [283, 0],
  "Starman, Starman Super (148 / 0)": [148, 0],
  "Mr. Molecule (68 / 0)": [68, 0],
  "Starman Super, Atomic Power Robot (286 / 0)": [286, 0],
  "Thunder and Storm (176 / 175)": [176, 175],
  "Uncontrollable Sphere (311 / 0)": [311, 0],
  "Big Pile of Puke (58 / 0)": [58, 0],
  "Evil Elemental (104 / 0)": [104, 0],
  "Evil Elemental, Psychic Psycho (325 / 0)": [325, 0],
  "Hyper Spinning Robo, Conducting Spirit (310 / 0)": [310, 0],
  "Uncontrollable Sphere, Conducting Spirit (309 / 0)": [309, 0],
  "Atomic Power Robot, Military Octobot (287 / 0)": [287, 0],
  "Care Free Bomb, Mr. Molecule (71 / 0)": [71, 0],
  "Ego Orb (66 / 0)": [66, 0],
  "Evil Elemental, Soul Consuming Flame (299 / 0)": [299, 0],
  "Psychic Psycho (303 / 0)": [303, 0],
  "Conducting Spirit (103 / 0)": [103, 0],
  "Hostile Elder Oak (57 / 0)": [57, 0],
  "Loaded Dice (323 / 0)": [323, 0],
  "Loaded Dice (67 / 0)": [67, 0],
  "Soul Consuming Flame (106 / 0)": [106, 0],
  "Wetnosaur (64 / 0)": [64, 0],
  "Care Free Bomb (322 / 0)": [322, 0],
  "Master Barf (211 / 210)": [211, 210],
  "Psychic Psycho, Major Psychic Psycho (105 / 0)": [105, 0],
  "Chomposaur (65 / 0)": [65, 0],
  "Electro Swoosh (268 / 0)": [268, 0],
  "Evil Eye, Mechanical Octobot (116 / 0)": [116, 0],
  "Ghost of Starman, Evil Eye (114 / 0)": [114, 0],
  "Ghost of Starman, Mechanical Octobot, Evil Eye (117 / 0)": [117, 0],
  "Starman Deluxe (199 / 0)": [199, 0],
  "Ghost of Starman, Nuclear Reactor Robot (107 / 0)": [107, 0],
  "Ghost of Starman, Nuclear Reactor Robot (297 / 0)": [297, 0],
  "Electro Specter (164 / 163)": [164, 163],
  "Ghost of Starman, Final Starman, Nuclear Reactor Robot (301 / 0)": [301, 0],
  "Ghost of Starman, Mechanical Octobot (115 / 0)": [115, 0],
  "Nuclear Reactor Robot, Final Starman (110 / 0)": [110, 0],
  "Ultimate Octobot, Nuclear Reactor Robot (209 / 0)": [209, 0],
  "Wild 'n Wooly Shambler, Ultimate Octobot (111 / 0)": [111, 0],
  "Ghost of Starman, Final Starman (300 / 0)": [300, 0],
  "Squatter Demon (296 / 0)": [296, 0],
  "Bionic Kraken (109 / 0)": [109, 0],
  "Carbon Dog (166 / 165)": [166, 165],
  "French Kiss of Death (70 / 0)": [70, 0],
  "Ness's Nightmare (298 / 0)": [298, 0],
  "Giygas, Heavily Armed Pokey (220 / 0)": [220, 0],
  "Giygas, Heavily Armed Pokey (222 / 221)": [222, 221],
  "Giygas (224 / 223)": [224, 223],
  "Giygas (225 / 0)": [225, 0],
  "Giygas (226 / 0)": [226, 0],
  "Giygas (227 / 0)": [227, 0],
  "Giygas (265 / 0)": [265, 0],
};

let content,
  endlessIntervalID,
  layer1,
  layer2,
  suggested,
  aspectRatio,
  frameskip;

document.addEventListener("DOMContentLoaded", function () {
  content = document.querySelector("section#everything");
  layer1 = document.getElementById("layer1");
  layer2 = document.getElementById("layer2");
  suggested = document.getElementById("suggested");
  aspectRatio = document.getElementById("aspectRatio");
  frameskip = document.getElementById("frameskip");
  let randomLayer = document.getElementById("randomLayer");
  let endlessRandom = document.getElementById("endlessRandom");
  let fullscreen = document.getElementById("fullscreen");

  // okay, we haven't gone fullscreen
  if (content) {
    endlessIntervalID = null;
    randomLayer.onclick = setRandomLayer;
    endlessRandom.onclick = setEndlessRandom;
    fullscreen.onclick = setupFullscreen;
    createLayerDropdown();
    createSuggestedLayersDropdown();
    setupDropdownPushStates();
    setupSelectedValues();
  }

  window.History.Adapter.bind(window, "statechange", function () {
    setupEngine();
  });
});

function createLayerDropdown() {
  var optionHtml = "";
  for (var i = 0; i < 327; i++) {
    optionHtml += "<option value='" + i + "'>" + i + "</option>";
  }

  layer1.innerHTML = optionHtml;
  layer2.innerHTML = optionHtml;
}

function createSuggestedLayersDropdown() {
  let optionHtml = "<option value='-1'></option>";

  for (var key in suggestedLayers) {
    if (suggestedLayers.hasOwnProperty(key)) {
      optionHtml += '<option value="' + key + '">' + key + "</option>";
    }
  }
  suggested.innerHTML = optionHtml;
}

function setupDropdownPushStates() {
  layer1.onchange = function (e) {
    var value = this.value;
    if (value < 0) {
      value = 0;
    }
    document.engine.layers[0] = new document.BackgroundLayer(value, ROM);
    History.pushState(
      { layer1: value },
      document.title,
      setUrlFromString("layer1=" + value)
    );
  };

  layer2.onchange = function (e) {
    var value = this.value;
    if (value < 0) {
      value = 0;
    }
    document.engine.layers[1] = new document.BackgroundLayer(value, ROM);
    History.pushState(
      { layer2: value },
      document.title,
      setUrlFromString("layer2=" + value)
    );
  };

  suggested.onchange = function (e) {
    var value = this.value;
    try {
      layer1.selectedIndex = suggestedLayers[value][0];
      layer1.onchange();
      layer2.selectedIndex = suggestedLayers[value][1];
      layer2.onchange();
    } catch (e) {}
  };

  aspectRatio.onchange = function (e) {
    var value = this.value;
    History.pushState(
      { aspectRatio: value },
      document.title,
      setUrlFromString("aspectRatio=" + value)
    );
  };

  frameskip.onchange = function (e) {
    var value = this.value;
    History.pushState(
      { frameskip: value },
      document.title,
      setUrlFromString("frameskip=" + value)
    );
  };
}

function setRandomLayer() {
  layer1.selectedIndex = String(Math.floor(Math.random() * 327));
  layer2.selectedIndex = String(Math.floor(Math.random() * 327));
  // Fake an onchange to set URL and redraw scene
  layer1.onchange();
  layer2.onchange();
}

function setEndlessRandom() {
  if (endlessIntervalID == null) {
    endlessRandom.textContent = "Endless Random (on)";
    setRandomLayer();
    endlessIntervalID = setInterval(function () {
      setRandomLayer();
    }, 7500);
  } else {
    clearInterval(endlessIntervalID);
    endlessRandom.textContent = "Endless Random (off)";
    endlessIntervalID = null;
  }
}

function setupSelectedValues() {
  var canvas = document.querySelector("canvas");

  var layerOneReplace = 'value="' + canvas.dataset.layerOne + '"';
  var layerTwoReplace = 'value="' + canvas.dataset.layerTwo + '"';
  layer1.innerHTML = layer1.innerHTML.replace(
    new RegExp(layerOneReplace),
    "selected " + layerOneReplace
  );
  layer2.innerHTML = layer2.innerHTML.replace(
    new RegExp(layerTwoReplace),
    "selected " + layerTwoReplace
  );

  var aspectRatioReplace = 'value="' + canvas.dataset.aspectRatio + '"';
  aspectRatio.innerHTML = aspectRatio.innerHTML.replace(
    new RegExp(aspectRatioReplace),
    "selected " + aspectRatioReplace
  );

  var frameskipReplace = 'value="' + canvas.dataset.frameskip + '"';
  frameskip.innerHTML = frameskip.innerHTML.replace(
    new RegExp(frameskipReplace),
    "selected " + frameskipReplace
  );
}

function setupFullscreen() {
  var canvas = document.querySelector("canvas");
  var content = document.querySelector("section#everything");
  if (canvas.getAttribute("id") != "full") {
    canvas.setAttribute("id", "full");
    content.classList.add("hidden");
    History.pushState(
      { fullscreen: true },
      document.title,
      setUrlFromString("fullscreen=" + true)
    );
  }
}

document.addEventListener("keyup", function (event) {
  if (event.keyCode == 27) {
    var canvas = document.querySelector("canvas");
    var content = document.querySelector("section#everything");
    canvas.setAttribute("id", "");
    content.classList.remove("hidden");
    History.pushState(
      { fullscreen: null },
      document.title,
      setUrlFromString("fullscreen=false")
    );
  }
});
